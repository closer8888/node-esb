var scanner = require("portscanner");

scanner.isLocked = false;

var findAPortNotInUse = scanner.findAPortNotInUse;
scanner.findAPortNotInUse = function(startPort, endPort, host, callback) {
    if(!scanner.isLocked){
        scanner.isLocked = true;
        findAPortNotInUse(startPort, endPort, host, function(error, port){
console.log('running callback')
            callback(error, port);
            //Make sure current port is locked before moving on
            var portLocked = setInterval(function(){
                var timePassed = 0;
                scanner.checkPortStatus(port, host, function(error, status){
                    if(status === "open" || timePassed > 20000){
                        scanner.isLocked = false;
                        clearInterval(portLocked);
                    }else{
                        timePassed += 500;
                    }
                });
            }, 500);
        });
    }else{
        var timing = setInterval(function(){
console.log("Scanner is locked: " + scanner.isLocked);
            var timePassed = 0;
            if(!scanner.isLocked || timePassed > 20000){
                clearInterval(timing);
console.log('interval cleared')
                scanner.isLocked = false;
                scanner.findAPortNotInUse(startPort, endPort, host, callback);
            }else{
                timePassed += 250;
            }
        }, 250);
        
    }
};


module.exports = scanner;
