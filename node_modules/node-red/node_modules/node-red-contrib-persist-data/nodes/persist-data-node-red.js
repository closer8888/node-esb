var mysql = require('mysql');
var when = require('when');
var content;
var conts = fs.readFileSync('/SitscapeData/PROD/conf/ss_installation.ini').toString().split("\n");;
var ss_db_server = 'localhost';
var ss_db_pwd = 'dpuser';
var variables = {};
if(conts.length > 0){
    conts.forEach(function(val, ind, arr){
        var tmp_val = val.split('=');
        var new_val = tmp_val[1];
        if(tmp_val.length > 3){
            for(var j=2;j<tmp_val.length;j++){
                new_val += tmp_val[j];
            }
        }
        if(typeof new_val != 'undefined' && tmp_val[0] != '' && typeof tmp_val[0] != 'undefined'){
            variables[tmp_val[0]] = new_val;
        }
    });
    ss_db_server = variables['SS_DB_SERVER'];
    var tmp_1 = variables['SS_DB_USER_PASS'].split("'");
    if(tmp_1[1] != ''){
        ss_db_pwd = new Buffer(tmp_1[1], 'base64').toString('ascii');
        ss_db_pwd = ss_db_pwd.replace(new RegExp('\n', 'g'), '');
    }
}
var DBSettings = {
    host : ss_db_server,
    user : "dpuser",
    password : ss_db_pwd
};

module.exports = function(RED) {
	"use strict";
    function persistDB(config) {
        RED.nodes.createNode(this,config);
        var node = this;
        var gid = config.z;
        var encKey = "ABQIAAAAvFEFnIRDLc0";
        var id = config.id;
        if(id && id != ''){
        	var tmp_id = id.split('.');
        	id = tmp_id.join('');
        }
        
		try {
			var pool = mysql.createPool(DBSettings);
			pool.getConnection(function(err, connection){
				if(err){

				} else {
					if(id && id != ''){
						var sql = "CREATE TABLE IF NOT EXISTS userfiles.ss_live_data_" + id + " (`value` int(11) NOT NULL, `datetime` datetime NOT NULL, `enum1` varchar(2500) NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=latin1";
						connection.query(sql, function(err3, rows3){
							if(err3){
								console.log(err3);
							} else {
								node.on("input", function(msg){
									var payload = msg.payload;
									if(payload && payload.length > 0){
										payload.forEach(function(ele, ind, arr){
											var value = ele.value;
											var datetime = ele.datetime;
											if(ele.no_persist){
												// do nothing
											} else {
												var sql_insert = "INSERT INTO userfiles.ss_live_data_" + id + " SET value='" + value + "', datetime='" + datetime + "'";
												connection.query(sql_insert, function(err4, rows4){
													if(err4){
														console.log('cannot insert data');
														console.log(err4);
													}
												});
											}
										});
									}
								});
							}
						});
					}
				}
				connection.release();
			});
		} catch(try_err){

		}
    }
    RED.nodes.registerType("Persist Data", persistDB);
}