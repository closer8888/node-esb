module.exports = function(RED) {
	"use strict";
    function aggregation(config) {
        RED.nodes.createNode(this,config);
        var node = this;
        var funct = config.funct;
        var topic = config.topic;
        this.on('input', function(msg) {
            var payload = msg.payload;
            var units = msg.units;
            var data_output = {};
            if(funct == 'count'){
                if(topic == 'numrec'){
                    payload.forEach(function(ele, ind, arr){
                        var ms_timein = ele.time_added_to_buffer;
                        var timein = new Date(ms_timein);
                        var converted_time = '';
                        if(units == 'ms') {
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes() + ':' + timein.getSeconds() + ':' + timein.getMilliseconds();
                        } else if(units == 'sec'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes() + ':' + timein.getSeconds();
                        } else if(units == 'min'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes();
                        } else if(units == 'hr'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours();
                        }

                        if(typeof data_output[converted_time] == 'undefined'){
                            data_output[converted_time] = {value: 1, datetime: converted_time, ms_timein: ms_timein};
                        } else {
                            data_output[converted_time].value += 1;
                        }
                    });
                    if(payload.length > 0){
                        var new_payload = [];
                        for(var key in data_output){
                            if(data_output.hasOwnProperty(key)){
                                new_payload.push(data_output[key]);
                            }
                        }
                        node.send({payload: new_payload});
                    } else {
                        var ms_timein = Date.now();
                        var timein = new Date(ms_timein);
                        var converted_time = '';
                        if(units == 'ms') {
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes() + ':' + timein.getSeconds() + ':' + timein.getMilliseconds();
                        } else if(units == 'sec'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes() + ':' + timein.getSeconds();
                        } else if(units == 'min'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours() + ':' + timein.getMinutes();
                        } else if(units == 'hr'){
                            converted_time = timein.getFullYear() + '-' + (timein.getMonth()+1) + '-' + timein.getDate() + ' ' + timein.getHours();
                        }
                        node.send({payload: [{value: 0, datetime: converted_time, ms_timein: ms_timein, no_persist: true}]});
                    }
                }
            }
        });

        this.on('close', function(){
            //
        });
    }
    RED.nodes.registerType("aggregation", aggregation);
}